#==============================================================================
# vim: softtabstop=2 shiftwidth=2 expandtab fenc=utf-8 cc=81 tw=80
#==============================================================================
#
# DESCRIPTION: An applicance for batsim experiments en development.
#
#==============================================================================
---
extend: default/from_image/from_docker

global:
  backend: docker
  from_docker_image: oarteam/batsim_ci:latest
  to_docker_image: oarteam/batsim:latest
  dir: /root

  batsim_commit: 9a300be66 # Mon Jan 9 16:17:09 2017

bootstrap:
  - "@base"

setup:
  - build_and_install_batsim:
    - do_it:
      - exec_in: |
          cd $${dir}
          git clone https://github.com/oar-team/batsim.git
      - exec_in: |
          cd $${dir}/batsim
          git checkout $${batsim_commit}
          mkdir build
      - exec_in: |
          cd $${dir}/batsim/build
          cmake .. -DCMAKE_CXX_COMPILER=/usr/bin/g++-6
          make -j$(nproc)
          make install
export:
  - "@base"
  - tag_and_push_image:
    - do_tag:
      - exec_local: |
          docker tag oarteam/$${kameleon_recipe_name}:latest oarteam/$${kameleon_recipe_name}:$(date --iso-8601)
    - do_push:
      - exec_local: |
          docker push oarteam/$${kameleon_recipe_name}:latest
          docker push oarteam/$${kameleon_recipe_name}:$(date --iso-8601)

